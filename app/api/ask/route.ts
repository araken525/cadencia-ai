export const runtime = "nodejs";

import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY!,
});

type ReqBody = {
  selectedNotes?: string[];
  analysis?: any;     // /api/analyze „ÅÆ„É¨„Çπ„Éù„É≥„Çπ‰∏∏„Åî„Å®„Åß„ÇÇOK
  engineChord?: string;
  question?: string;
};

function safeJson(v: any) {
  try { return JSON.stringify(v, null, 2); } catch { return String(v); }
}

function normalizeAccidentals(s: string) {
  return (s ?? "")
    .trim()
    .replaceAll("‚ô≠", "b")
    .replaceAll("‚ôØ", "#")
    .replaceAll("ùÑ´", "bb")
    .replaceAll("ùÑ™", "##");
}

export async function POST(req: Request) {
  try {
    const body = (await req.json()) as ReqBody;

    const selectedNotes = (body.selectedNotes ?? []).map(normalizeAccidentals).filter(Boolean);
    const engineChord = (body.engineChord ?? "").trim();
    const analysis = body.analysis ?? null;
    const question = (body.question ?? "").trim();

    if (selectedNotes.length < 3) {
      return new Response("3Èü≥‰ª•‰∏äÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ", { status: 400 });
    }

    // fallback (API„Ç≠„ÉºÁÑ°„Åó„Åß„ÇÇÂ£ä„Çå„Å™„ÅÑ)
    if (!process.env.OPENAI_API_KEY) {
      const msg = [
        "ÔºàAIÊú™Êé•Á∂öÔºâ",
        `ÂÖ•Âäõ: ${selectedNotes.join(", ")}`,
        `Âà§ÂÆö: ${engineChord || "ÔºàÊú™ÊåáÂÆöÔºâ"}`,
        "",
        "OPENAI_API_KEY „ÇíË®≠ÂÆö„Åô„Çã„Å®Ë≥™Âïè„Å´AI„ÅåÁ≠î„Åà„Åæ„Åô„ÄÇ",
      ].join("\n");
      return new Response(msg, { headers: { "Content-Type": "text/plain; charset=utf-8" } });
    }

    const SYSTEM = `
„ÅÇ„Å™„Åü„ÅØÂè§ÂÖ∏ÂíåÂ£∞ÔºàÊ©üËÉΩÂíåÂ£∞Ôºâ„ÇíÂ∞ÇÈñÄ„Å®„Åô„ÇãÈü≥Ê•ΩÁêÜË´ñÂÆ∂„Åß„Åô„ÄÇ
Èü≥Á®ã„ÉªÂ∫¶Êï∞„ÅØÂøÖ„Åö„ÄåÈü≥Âêç„ÅÆÊñáÂ≠óÈñìÈöîÔºàC‚ÄìD‚ÄìE‚ÄìF‚ÄìG‚ÄìA‚ÄìBÔºâ„Äç„ÅßÊâ±„ÅÑ„ÄÅ
ÂçäÈü≥Êï∞„ÉªÂÆüÈü≥È´ò„Éª„Éî„ÉÉ„ÉÅ„ÇØ„É©„Çπ„ÇíÂü∫Ê∫ñ„Å´Ë™¨Êòé„Åó„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì„ÄÇ
„ÅÇ„Å™„Åü„ÅÆÂΩπÂâ≤„ÅØ„ÄêË™¨Êòé„Å†„Åë„Äë„Åß„Åô„ÄÇ„Ç≥„Éº„ÉâÂêç„ÅÆÂà§ÂÆö„ÅØË°å„ÅÑ„Åæ„Åõ„Çì„ÄÇ
Ë≥™Âïè„Å´Á≠î„Åà„ÇãÈöõ„ÇÇ„ÄÅÂÖ•Âäõ„Åï„Çå„ÅüÈü≥ÂêçË°®Ë®ò„ÇíÊúÄÂÑ™ÂÖà„Åó„ÄÅ
„Äå‰∏ÄËà¨Ë´ñ„Äç„ÄåÂà•„ÅÆÂèØËÉΩÊÄß„Äç„ÇíÊñ∞„Åó„Åè‰Ωú„Å£„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì„ÄÇ

„ÄêÈü≥Á®ã„ÅÆÊï∞„ÅàÊñπÔºöÊúÄÈáçË¶Å„É´„Éº„É´„Äë
Èü≥Á®ãÔºàÂ∫¶Êï∞„ÉªÂ¢óÊ∏õÔºâ„ÅØÂøÖ„Åö„ÄåÈü≥Âêç„ÅÆÊñáÂ≠óÈñìÈöîÔºàC‚ÄìD‚ÄìE‚ÄìF‚ÄìG‚ÄìA‚ÄìBÔºâ„Äç„ÅßÊï∞„Åà„Çã„ÄÇ
ÂçäÈü≥Êï∞„ÄÅÂÆüÈü≥È´ò„ÄÅ„Éî„ÉÉ„ÉÅ„ÇØ„É©„Çπ„ÄÅÈçµÁõ§‰ΩçÁΩÆ„ÄÅMIDIÁï™Âè∑„ÄÅ12Âπ≥ÂùáÂæã„ÅÆÂêåÈü≥Êâ±„ÅÑ„ÇíÊ†πÊã†„Å´„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ

„ÄêÊâãÈ†ÜÔºöÂøÖ„Åö„Åì„ÅÆÈ†Ü„ÅßË®àÁÆó„Åó„ÄÅÈ£õ„Å∞„Åï„Å™„ÅÑ„Äë
ÂÖ•Âäõ„ÅØÂøÖ„Åö„ÄåÊ†πÈü≥X„Äç‚Üí„ÄåÂØæË±°Èü≥Y„Äç„ÅÆÈ†Ü„ÅßÊâ±„ÅÜ„ÄÇ

(1) „Åæ„ÅöÈü≥Âêç„ÅÆÊñáÂ≠ó„Å†„Åë„ÇíË¶ã„ÇãÔºà‚ôØ/‚ô≠/ùÑ™/ùÑ´„ÅØ‰∏ÄÊó¶ÁÑ°Ë¶ñÔºâ
    ‰æãÔºöX= D„ÄÅY= G# „Å™„ÇâÊñáÂ≠ó„ÅØ D „Å® G

(2) ÊñáÂ≠óÈñìÈöî„ÇíÊï∞„Åà„Å¶„Äå‚óØÂ∫¶„Äç„ÇíÁ¢∫ÂÆö„Åô„ÇãÔºàÂ∫¶Êï∞„ÅØÂøÖ„Åö 1 „Åã„ÇâÊï∞„Åà„ÇãÔºâ
    ÊñáÂ≠ó„ÇíÈ†Ü„Å´‰∏¶„Åπ„Å¶Êï∞„Åà„ÇãÔºöD(1)‚ÄìE(2)‚ÄìF(3)‚ÄìG(4)
    ‚Üí „Åì„ÅÆÊôÇÁÇπ„Åß„Äå4Â∫¶„Äç„Å®Á¢∫ÂÆö
    ‚Äª„ÄåÂ¢ó4Â∫¶Ôºà„Åæ„Åü„ÅØÊ∏õ5Â∫¶Ôºâ„Äç„ÅÆ„Çà„ÅÜ„Å´„ÄÅÂ∫¶Êï∞„Çí‰∫åÊäû„Å´„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ
      Â∫¶Êï∞„ÅØÊñáÂ≠óÈñìÈöî„Åß‰∏ÄÊÑè„Å´Ê±∫„Åæ„Çã„ÄÇ

(3) Ê¨°„Å´Â¢óÊ∏õ„ÇíÊ±∫„ÇÅ„ÇãÔºà„Åì„Åì„Åß„ÇÇÂçäÈü≥Êï∞„Çí‰Ωø„Çè„Å™„ÅÑÔºâ
    Â¢óÊ∏õ„ÅØ„Äå„Åù„ÅÆË°®Ë®ò„ÅåÁ§∫„ÅôÈü≥ÂêçÈñ¢‰øÇÔºà‚ôØ/‚ô≠/ùÑ™/ùÑ´Ôºâ„Äç„Å®„Åó„Å¶Ë™¨Êòé„Åô„Çã„ÄÇ
    ‰æãÔºöD‚ÜíG „ÅØÂÆåÂÖ®4Â∫¶„ÄÅD‚ÜíG# „ÅØ„Äå4Â∫¶„ÅÆG„Çí#„Åó„ÅüË°®Ë®ò„Äç„Å™„ÅÆ„ÅßÂ¢ó4Â∫¶„ÄÇ
    ‚Äª„Åì„ÅÆÊÆµÈöé„Åß„ÇÇ„ÄåÂÆüÈü≥„Åß„ÅØÂêå„Åò„Äç„Å™„Å©„ÅÆÈÄÉ„Åí„ÅØ‰∏çÂèØ„ÄÇ

(4) ÊúÄÁµÇÂá∫Âäõ„ÅØÂøÖ„Åö„ÄåÂ∫¶Êï∞ÔºãÂ¢óÊ∏õ„Äç„Çí„Çª„ÉÉ„Éà„ÅßÊõ∏„Åè
    OK‰æãÔºöÂ¢ó4Â∫¶ / Áü≠3Â∫¶ / Èï∑6Â∫¶ / ÂÆåÂÖ®5Â∫¶ / Ê∏õ7Â∫¶
    NG‰æãÔºö„Éà„É©„Ç§„Éà„Éº„É≥ / #11„Å£„ÅΩ„ÅÑ / ÂçäÈü≥„Åß6„Å§Èõ¢„Çå„Å¶„Çã / „Å†„ÅÑ„Åü„ÅÑÊ∏õ5Â∫¶

„ÄêÁ¶ÅÊ≠¢‰∫ãÈ†ÖÔºàÂòòÈò≤Ê≠¢Ôºâ„Äë
- „ÄåÂ¢ó4Â∫¶ ‚âí Ê∏õ5Â∫¶„Äç„ÅÆ„Çà„ÅÜ„Å´„ÄÅÊñáÂ≠óÈñìÈöî„ÅÆÈÅï„ÅÜÈü≥Á®ãÂêç„Çí‚ÄúÂêå„Åò‚Äù„Å®„Åó„Å¶Êâ±„ÅÜ„ÅÆ„ÅØÁ¶ÅÊ≠¢„ÄÇ
- „ÄåFb„ÅØE„Å®Âêå„ÅòÈ´ò„Åï„Äç„Å™„Å©„ÄÅÂÆüÈü≥È´ò„ÅÆ‰∏ÄËá¥„ÇíÊ†πÊã†„Å´Ë™¨Êòé„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑÔºàË™§Ëß£„Éù„Ç§„É≥„Éà„Å®„Åó„Å¶„ÅÆË®ÄÂèä„ÅÆ„ÅøÂèØÔºâ„ÄÇ
- ÊÉÖÂ†±‰∏çË∂≥„ÅÆÁÆáÊâÄ„ÅØÊé®Ê∏¨„ÅßÂüã„ÇÅ„Åö„ÄÅ„ÄåÂâçÂæåÊñáËÑà„ÅåÁÑ°„ÅÑ„ÅÆ„ÅßÁ¢∫ÂÆö„Åß„Åç„Å™„ÅÑ„Äç„Å®ÊòéË®Ä„Åô„Çã„ÄÇ

„ÄêÂá∫Âäõ„ÉÅ„Çß„ÉÉ„ÇØÔºàËá™ÂàÜ„ÅßÊ§úÁÆóÔºâ„Äë
ÊñáÁ´†„ÇíÂá∫„ÅôÂâç„Å´ÂøÖ„ÅöÁ¢∫Ë™çÔºö
- „Åô„Åπ„Å¶„ÅÆÈü≥Á®ãË°®Áèæ„Åå„ÄåÊñáÂ≠óÈñìÈöî„ÅßÂ∫¶Êï∞„Åå‰∏ÄÊÑè„Äç„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Åã
- ‚Äú„Åæ„Åü„ÅØ‚Äù„ÅßÂà•„ÅÆÂ∫¶Êï∞Âêç„Çí‰ΩµË®ò„Åó„Å¶„ÅÑ„Å™„ÅÑ„Åã
- ÂçäÈü≥„Éª„Éî„ÉÉ„ÉÅ„ÇØ„É©„Çπ„ÉªÂÆüÈü≥È´ò„ÅÆÊ†πÊã†„ÅåÊ∑∑„Åñ„Å£„Å¶„ÅÑ„Å™„ÅÑ„Åã

„ÄêÊúÄÈáçË¶Å„É´„Éº„É´ÔºàÂòòÈò≤Ê≠¢Ôºâ„Äë
- Èü≥Á®ãÂêçÔºàÂÆåÂÖ®„ÉªÈï∑„ÉªÁü≠„ÉªÂ¢ó„ÉªÊ∏õ‚óØÂ∫¶Ôºâ„ÅØ„ÄÅ
  ÂÖ•Âäõ„Åï„Çå„ÅüÈü≥ÂêçÂêåÂ£´„ÅÆ„ÄåÊñáÂ≠óÈñìÈöî„Äç„ÇíÊòéÁ§∫ÁöÑ„Å´Á¢∫Ë™ç„Åß„Åç„ÇãÂ†¥Âêà„Å´„ÅÆ„Åø‰ΩøÁî®„Åô„Çã„ÄÇ
  - „Äå‰∏çÂçîÂíå„Äç„ÄåÁ∑äÂºµÊÑü„Äç„Å™„Å©„ÅÆË©ï‰æ°Ë™û„ÅØ„ÄÅ
  ÂÖ∑‰ΩìÁöÑ„Å™Èü≥Á®ãÂêç„ÉªÊßãÈÄ†Ë™¨Êòé„Çí‰º¥„Çè„Å™„ÅÑÈôê„Çä‰ΩøÁî®Á¶ÅÊ≠¢„ÄÇ
- Á¢∫Ë™ç„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÄÅÈü≥Á®ãÂêç„Çí‰Ωø„Å£„Å¶„ÅØ„Å™„Çâ„Å™„ÅÑ„ÄÇ
- Èü≥Á®ãÂêçÔºàÂÆåÂÖ®„ÉªÈï∑„ÉªÁü≠„ÉªÂ¢ó„ÉªÊ∏õ‚óØÂ∫¶Ôºâ„ÅØ„ÄÅ
  Èü≥Âêç„ÅÆÊñáÂ≠óÈñìÈöî„Åã„Çâ‰∏ÄÊÑè„Å´Ê±∫„Åæ„Çã„ÇÇ„ÅÆ„ÅÆ„Åø‰ΩøÁî®„Åó„ÄÅ
  AI„ÅåÁã¨Ëá™„Å´ÂëΩÂêç„ÉªË®Ä„ÅÑÊèõ„Åà„ÉªËß£Èáà„Åó„Å¶„ÅØ„Å™„Çâ„Å™„ÅÑ„ÄÇ
- Èü≥Á®ãÂêçÔºàÈï∑3Â∫¶„ÉªÂÆåÂÖ®5Â∫¶„ÉªÊ∏õ5Â∫¶„Å™„Å©Ôºâ„ÅØ„ÄÅ
  ÂÖ•Âäõ„Åï„Çå„ÅüÈü≥ÂêçÂêåÂ£´„ÅÆÊñáÂ≠óÈñìÈöî„Åã„ÇâÊ©üÊ¢∞ÁöÑ„Å´Ê±∫„Åæ„Çã„ÇÇ„ÅÆ„Å†„Åë„Çí‰ΩøÁî®„Åó„ÄÅ
  Êé®Ê∏¨„ÉªË®Ä„ÅÑÊèõ„Åà„ÉªÊ©üËÉΩÁöÑËß£Èáà„ÅßÊñ∞„Åü„Å´ÂëΩÂêç„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ„ÄÇ
- engineChord „ÅÆË°®Ë®ò„ÇíÂ§âÊõ¥„Åó„Å™„ÅÑÔºàË®Ä„ÅÑÊèõ„Åà„ÉªÂÜçÂà§ÂÆö„Åó„Å™„ÅÑÔºâ„ÄÇ
- Ë™øÊÄßÔºà„Ç≠„ÉºÔºâ„ÅØÊñ≠ÂÆö„Åó„Å™„ÅÑ„ÄÇ„ÄåÂèØËÉΩÊÄß„Äç„Çí2„Äú3ÂÄã„Åæ„Åß„ÄÇ
- Áï∞ÂêçÂêåÈü≥„ÅØÂêå‰∏ÄË¶ñ„Åó„Å™„ÅÑ„ÄÇA# „Å® Bb„ÄÅCb „Å® B „ÇíÂêå„Åò„Å®Êñ≠Ë®Ä„Åó„Å™„ÅÑÔºà„Åü„Å†„ÅóË™§Ëß£„Éù„Ç§„É≥„Éà„Å®„Åó„Å¶Ëß¶„Çå„Çã„ÅÆ„ÅØÂèØÔºâ„ÄÇ
- ÂâçÂæå„ÅÆÈÄ≤Ë°å„ÅåÁÑ°„ÅÑÂâçÊèê„Å™„ÅÆ„ÅßÊñ≠Ë®Ä„ÇíÈÅø„Åë„Äå‰ªÆË™¨„Äç„Å®„Åó„Å¶Ëø∞„Åπ„Çã„ÄÇ
- ‰∏çÊòé„Å™ÁÇπ„ÅØ„ÄåÊÉÖÂ†±‰∏çË∂≥„Äç„Å®Ë®Ä„ÅÑÂàá„Å£„Å¶„Çà„ÅÑÔºàÊé®Ê∏¨„ÅßÂüã„ÇÅ„Å™„ÅÑÔºâ„ÄÇ

„ÄêÂá∫Âäõ„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà„Åì„ÅÆÈ†ÜÔºâ„Äë
A. „Å≤„Å®„Åì„Å®„ÅßÔºà1„Äú2Ë°åÔºâ
B. ‰∏ªËß£ÈáàÔºàengineChord / Ê©üËÉΩ / Ë™øÊÄß‰ªÆË™¨„Å§„Åç„É≠„Éº„ÉûÊï∞Â≠óÔºâ
C. Ê∫ñËß£ÈáàÔºàÂêå‰∏äÔºâ
D. Âà•Ëß£ÈáàÔºàÂêå‰∏ä„ÄÅÁÑ°„Åë„Çå„Å∞ÁúÅÁï•Ôºâ
E. ÈùûÂíåÂ£∞Èü≥„ÅÆË¶ãÁ´ã„Å¶Ôºà„Å©„ÅÆÈü≥„Åå„Å©„ÅÆÁ®ÆÈ°û„Å£„ÅΩ„ÅÑ„ÅãÔºâ
F. Ê¨°„Å´ÂàÜ„Åã„Çã„Åì„Å®ÔºàÂâçÂæå„ÅåÂàÜ„Åã„Çã„Å®‰Ωï„ÅåÁ¢∫ÂÆö„Åô„Çã„ÅãÔºâ
`.trim();

    const userPrompt = `
„ÄêÂÖ•ÂäõÔºàË°®Ë®ò„ÅØ„Åù„ÅÆ„Åæ„ÅæÂ∞äÈáçÔºâ„Äë
ÈÅ∏ÊäûÈü≥: ${selectedNotes.join(", ")}
engineChord: ${engineChord || "ÔºàÊú™ÊåáÂÆöÔºâ"}

„ÄêËß£Êûê„Éá„Éº„ÇøÔºàÂèÇËÄÉ„ÄÇÂà§ÂÆö„ÅØÂ§â„Åà„Å™„ÅÑÔºâ„Äë
${safeJson(analysis)}

„ÄêË≥™Âïè„Äë
${question || "ÔºàË≥™Âïè„Å™„ÅóÔºöËá™ÂãïËß£Ë™¨„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ"}

„Äê‰æùÈ†º„Äë
Ë≥™Âïè„Å´Á≠î„Åà„Å§„Å§„ÄÅA„ÄúF „ÅßË™¨Êòé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
Áâπ„Å´Áï∞ÂêçÂêåÈü≥ÔºàCbÁ≠âÔºâ„Å´„Å§„ÅÑ„Å¶„ÄÅÂøÖË¶Å„Å™„ÇâË™§Ëß£„Éù„Ç§„É≥„Éà„Å®„Åó„Å¶Ëß¶„Çå„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
`.trim();

    const completion = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      temperature: 0.2,
      messages: [
        { role: "system", content: SYSTEM },
        { role: "user", content: userPrompt },
      ],
    });

    const text = completion.choices[0]?.message?.content?.trim() ?? "";
    return new Response(text || "ÔºàAI„ÅÆÂøúÁ≠î„ÅåÁ©∫„Åß„Åó„ÅüÔºâ", {
      headers: { "Content-Type": "text/plain; charset=utf-8" },
    });
  } catch (err: any) {
    return new Response(err?.message ?? "Unknown error", { status: 500 });
  }
}